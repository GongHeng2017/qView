steps:
  # APNG

- pwsh: ci/pwsh/buildapng.ps1
  displayName: Build APNG plugin

- pwsh: ci/pwsh/buildkimageformats.ps1
  condition: ne( variables['skipHardPlugins'], 'true' )
  displayName: Build KImageFormats plugin

  # HEIF
  # Skip HEIF on mac because Qt supports HEIF on mac for some reason
- bash: |
    git clone https://github.com/strukturag/libde265
    cd libde265
    git checkout $(git tag | tail -1)

    git clone https://github.com/strukturag/libheif
    cd libheif
    git checkout $(git tag | tail -1)

    git clone https://github.com/jurplel/qt-heif-image-plugin.git
    cd qt-heif-image-plugin
    git checkout patch-1
  condition: and(ne( variables['skipHardPlugins'], 'true' ), ne( variables['Agent.OS'], 'Darwin' ))
  displayName: Clone HEIF plugin
  
- bash: |
    cd libde265
    ./autogen.sh
    ./configure --disable-sherlock265
    make
    sudo make install

    cd libheif
    ./autogen.sh
    ./configure
    make
    sudo make install
    
    cd qt-heif-image-plugin
    cmake .
    make
    sudo make install
  condition: and(ne( variables['skipHardPlugins'], 'true' ), eq( variables['Agent.OS'], 'Linux' ))
  displayName: Build HEIF plugin (Linux)

- script: |
    call "%programfiles(x86)%\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars%arch:~3,2%.bat"
    
    cd libde265
    cmake -G Ninja -DCMAKE_BUILD_TYPE=Release
    ninja
    
    cd libheif
    cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DLIBDE265_LIBRARY="../libde265/libde265.lib" -DLIBDE265_INCLUDE_DIR="../" -DCMAKE_INSTALL_PREFIX="C:/libheif" .
    ninja
    ninja install
    
    choco install pkgconfiglite --allow-empty-checksums
    set PKG_CONFIG_PATH=C:\libheif\lib\pkgconfig
    
    cd qt-heif-image-plugin
    cmake -G Ninja -DCMAKE_BUILD_TYPE=Release .
    ninja
  condition: and(ne( variables['skipHardPlugins'], 'true' ), eq( variables['Agent.OS'], 'Windows_NT' ))
  displayName: Build HEIF plugin (Windows)

  # gtk2 and qt5ct style plugins for linux appimages
- bash: |
    git clone https://code.qt.io/qt/qtstyleplugins.git
    cd qtstyleplugins
    qmake
    sudo make install

    wget 'https://sourceforge.net/projects/qt5ct/files/latest/download'
    tar xf download
    cd qt5ct*
    qmake
    sudo make install
    
    echo "##vso[task.setvariable variable=extra_plugins_maybe]'-extra-plugins=styles/libqt5ct-style.so,platformthemes/libqt5ct.so,iconengines,platformthemes/libqgtk3.so,imageformats/libqapng.so,imageformats/libqavif.so,imageformats/libqheif.so'"
  condition: eq( variables['Agent.OS'], 'Linux' )
  displayName: Get extra styles (Linux)
